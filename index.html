<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Web FPS Prototipi - Three.js</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px;
            background: transparent;
            border: 2px solid rgba(0, 255, 0, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }
        #crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; background: red;
            transform: translate(-50%, -50%); border-radius: 50%;
        }
        #ui-layer {
            position: absolute; top: 20px; left: 20px; color: #0f0;
            font-size: 18px; text-shadow: 1px 1px 2px #000; pointer-events: none;
        }
        #instructions {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; background: rgba(0,0,0,0.7);
            padding: 20px; border-radius: 10px; cursor: pointer; border: 1px solid #444;
        }
        .bar-container { width: 200px; height: 20px; background: #333; margin-top: 5px; border: 1px solid #555; }
        #health-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #c00, #f00); transition: width 0.2s; }
        #ammo-info { margin-top: 10px; font-weight: bold; color: #ffcc00; }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    <div id="ui-layer">
        <div>CAN: <div class="bar-container"><div id="health-bar"></div></div></div>
        <div id="ammo-info">MERMİ: 30 / ∞</div>
        <div id="score-board">SKOR: 0</div>
        <div style="font-size: 12px; color: #aaa; margin-top:10px;">FPS: <span id="fps-counter">60</span></div>
    </div>

    <div id="instructions">
        <h1>OPERASYON: WEB GL</h1>
        <p>Hareket: W, A, S, D</p>
        <p>Zıpla: BOŞLUK | Koş: SHIFT</p>
        <p>Ateş: SOL TIK</p>
        <p style="color:#0f0; font-weight:bold;">BAŞLAMAK İÇİN TIKLA</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- DEĞİŞKENLER ---
        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let canJump = false, isSprinting = false;
        
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        
        // Oyun Durumu
        let score = 0;
        let health = 100;
        let bullets = 30;
        let enemies = [];
        let lastShotTime = 0;
        
        // Elemanlar
        const instructions = document.getElementById('instructions');
        const scoreEl = document.getElementById('score-board');
        const healthEl = document.getElementById('health-bar');
        const ammoEl = document.getElementById('ammo-info');
        const fpsEl = document.getElementById('fps-counter');

        init();
        animate();

        function init() {
            // 1. Sahne Kurulumu
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);
            scene.fog = new THREE.Fog(0x111111, 0, 70); // Sis efekti derinlik katar

            // 2. Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6; // Göz hizası

            // 3. Işıklar
            const light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
            light.position.set(0.5, 1, 0.75);
            scene.add(light);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); // Güneş ışığı gibi gölge yapar
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            // 4. Kontroller (Pointer Lock)
            controls = new PointerLockControls(camera, document.body);

            instructions.addEventListener('click', function () {
                controls.lock();
            });

            controls.addEventListener('lock', function () {
                instructions.style.display = 'none';
            });

            controls.addEventListener('unlock', function () {
                instructions.style.display = 'block';
            });

            scene.add(controls.getObject());

            // 5. Tuş Dinleyicileri
            const onKeyDown = function (event) {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = true; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                    case 'ArrowRight': case 'KeyD': moveRight = true; break;
                    case 'Space': if (canJump === true) velocity.y += 350; canJump = false; break;
                    case 'ShiftLeft': isSprinting = true; break;
                }
            };

            const onKeyUp = function (event) {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = false; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                    case 'ArrowRight': case 'KeyD': moveRight = false; break;
                    case 'ShiftLeft': isSprinting = false; break;
                }
            };

            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousedown', shoot); // Ateş etme

            // 6. Çevre (Zemin ve Nesneler)
            
            // Zemin
            const floorGeometry = new THREE.PlaneGeometry(200, 200, 100, 100);
            floorGeometry.rotateX(-Math.PI / 2);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x222222, 
                wireframe: false,
                roughness: 0.8 
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.receiveShadow = true;
            scene.add(floor);

            // Rastgele Kutular (Siperler)
            const boxGeo = new THREE.BoxGeometry(5, 5, 5);
            const boxMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
            
            for(let i=0; i<30; i++) {
                const box = new THREE.Mesh(boxGeo, boxMat);
                box.position.x = Math.random() * 100 - 50;
                box.position.z = Math.random() * 100 - 50;
                box.position.y = 2.5;
                box.castShadow = true;
                box.receiveShadow = true;
                scene.add(box);
            }

            // Silah (Basit bir dikdörtgen)
            const gunGeo = new THREE.BoxGeometry(0.2, 0.2, 1);
            const gunMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const gun = new THREE.Mesh(gunGeo, gunMat);
            gun.position.set(0.3, -0.3, -0.5);
            camera.add(gun); // Silahı kameraya bağla

            // 7. Renderer Ayarları
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; // Gölgeleri aç
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', onWindowResize);
            
            // Düşmanları başlat
            spawnEnemy();
            setInterval(spawnEnemy, 3000); // Her 3 saniyede bir düşman
        }

        // --- OYUN FONKSİYONLARI ---

        function spawnEnemy() {
            if(enemies.length > 20) return; // Maksimum düşman sınırı

            const geometry = new THREE.CapsuleGeometry(1, 2, 4, 8); // İnsan şekline yakın
            const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
            const enemy = new THREE.Mesh(geometry, material);

            // Rastgele konum (oyuncudan biraz uzakta)
            const angle = Math.random() * Math.PI * 2;
            const radius = 20 + Math.random() * 30;
            enemy.position.x = controls.getObject().position.x + Math.cos(angle) * radius;
            enemy.position.z = controls.getObject().position.z + Math.sin(angle) * radius;
            enemy.position.y = 1;
            
            enemy.castShadow = true;
            enemy.userData = { health: 3, speed: 5 + Math.random() * 5 }; // Düşman verisi
            
            scene.add(enemy);
            enemies.push(enemy);
        }

        function shoot() {
            if (!controls.isLocked) return;
            if (bullets <= 0) {
                bullets = 30; // Şarjör değiştirme (Basit)
                ammoEl.textContent = "DOLDURULUYOR...";
                setTimeout(() => { ammoEl.textContent = `MERMİ: ${bullets} / ∞`; }, 1000);
                return;
            }

            const now = performance.now();
            if (now - lastShotTime < 100) return; // Ateş hızı sınırı
            lastShotTime = now;

            bullets--;
            ammoEl.textContent = `MERMİ: ${bullets} / ∞`;

            // Namlu efekti (Silahın ucunda küçük sarı ışık)
            const flash = new THREE.PointLight(0xffff00, 1, 3);
            flash.position.set(0.5, -0.5, -1);
            camera.add(flash);
            setTimeout(() => camera.remove(flash), 50);
            
            // Geri tepme (Kamera sarsıntısı)
            camera.rotation.x += 0.01; 

            // Raycaster (Merminin gittiği yer)
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera( new THREE.Vector2(0,0), camera ); // Ekranın tam ortasından

            const intersects = raycaster.intersectObjects(scene.children);

            for ( let i = 0; i < intersects.length; i ++ ) {
                const object = intersects[i].object;
                if(enemies.includes(object)) {
                    // Düşmana vurduk
                    object.material.color.set(0xffffff); // Vurulma efekti (beyaz yanıp sönme)
                    setTimeout(() => { 
                        if(object.parent) object.material.color.set(0xff0000); 
                    }, 100);
                    
                    object.userData.health--;
                    if(object.userData.health <= 0) {
                        scene.remove(object);
                        enemies.splice(enemies.indexOf(object), 1);
                        score += 100;
                        scoreEl.textContent = "SKOR: " + score;
                    }
                    
                    // Kan efekti simülasyonu (partikül) - Basit
                    createParticles(intersects[i].point, 0xff0000);
                    break; // Sadece ilk vurulanı etkile
                } else if (object.geometry.type === 'BoxGeometry' || object.geometry.type === 'PlaneGeometry') {
                    // Duvara/Yere vurduk
                    createParticles(intersects[i].point, 0xaaaaaa);
                    break;
                }
            }
        }

        function createParticles(position, color) {
            // Vuruş noktasında küçük küpler saç
            const particleGeo = new THREE.BoxGeometry(0.1, 0.1, 0.1);
            const particleMat = new THREE.MeshBasicMaterial({ color: color });
            
            for(let i=0; i<5; i++) {
                const particle = new THREE.Mesh(particleGeo, particleMat);
                particle.position.copy(position);
                particle.position.x += (Math.random() - 0.5) * 0.5;
                particle.position.y += (Math.random() - 0.5) * 0.5;
                particle.position.z += (Math.random() - 0.5) * 0.5;
                scene.add(particle);
                
                // Partikülü 0.5 saniye sonra sil
                setTimeout(() => scene.remove(particle), 500);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked === true) {
                
                // FPS Göstergesi
                fpsEl.textContent = Math.round(1/delta);

                // --- OYUNCU HAREKETİ ---
                // Sürtünme (Hız kesme)
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 9.8 * 100.0 * delta; // Yerçekimi

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // Çapraz giderken hızlanmayı önle

                const speed = isSprinting ? 800.0 : 400.0;

                if (moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * speed * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
                
                controls.getObject().position.y += (velocity.y * delta); // Zıplama

                // Zemin Kontrolü (Basit Fizik)
                if (controls.getObject().position.y < 1.6) {
                    velocity.y = 0;
                    controls.getObject().position.y = 1.6;
                    canJump = true;
                }

                // --- DÜŞMAN YAPAY ZEKASI ---
                enemies.forEach(enemy => {
                    const playerPos = controls.getObject().position;
                    const enemyPos = enemy.position;
                    
                    // Oyuncuya yönel
                    const dx = playerPos.x - enemyPos.x;
                    const dz = playerPos.z - enemyPos.z;
                    const distance = Math.sqrt(dx*dx + dz*dz);
                    
                    if(distance > 1.5) { // Çok yaklaşınca dur
                        enemyPos.x += (dx / distance) * enemy.userData.speed * delta;
                        enemyPos.z += (dz / distance) * enemy.userData.speed * delta;
                        enemy.lookAt(playerPos.x, enemy.position.y, playerPos.z);
                    } else {
                        // Hasar ver
                        health -= 0.5;
                        healthEl.style.width = health + "%";
                        if(health <= 0) {
                            document.exitPointerLock();
                            alert("OYUN BİTTİ! SKORUN: " + score);
                            location.reload();
                        }
                    }
                });
            }

            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
